<main>
    <!-- ========== PAGE HEADER ========== -->
    <section class="page-header-section py-5">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <h1 class="page-title">Checkout</h1>
                    <p class="page-subtitle">Review your items and complete your purchase</p>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb justify-content-center">
                            <li class="breadcrumb-item"><a href="/">Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- ========== CART ITEMS ========== -->
    <section class="checkout-cart-section py-5">
        <div class="container">
            {{#if products.length}}
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each products}}
                                <tr>
                                    <td>
                                        <img src="{{{this.image_url}}}" alt="{{this.name}}" class="img-fluid"
                                            style="width:80px; height:80px; object-fit:cover;">
                                    </td>
                                    <td>{{this.name}}</td>
                                    <td>₦{{this.price}}</td>
                                    <td>
                                        <input type="number" class="form-control quantity-input"
                                            data-product-id="{{this.id}}" value="{{this.quantity}}" min="1">
                                    </td>
                                    <td>₦{{multiply this.price this.quantity}}</td>
                                </tr>
                                {{/each}}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="4" class="text-end">Total:</th>
                                    <th>
                                        ₦{{totalPrice products}}
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Checkout Button -->
            <div class="row mt-4">
                <div class="col-12 text-end">
                    <button id="payButton" class="btn btn-success btn-lg">Proceed to Payment</button>
                </div>
            </div>

            {{else}}
            <div class="row">
                <div class="col-12 text-center py-5">
                    <h4>Your cart is empty!</h4>
                    <a href="/product" class="btn btn-primary mt-3">Shop Products</a>
                </div>
            </div>
            {{/if}}
        </div>
    </section>

    <!-- PAYMENT DETAILS MODAL -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Enter Your Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <form id="paymentForm">
                        <div class="mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" name="email" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Address *</label>
                            <input type="text" name="address" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">State *</label>
                            <input type="text" name="state" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Nationality *</label>
                            <input type="text" name="nationality" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Phone *</label>
                            <input type="text" name="phone" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Alternative Phone</label>
                            <input type="text" name="alt_phone" class="form-control">
                        </div>

                        <!-- Submit inside form -->
                        <button type="submit" class="btn btn-success w-100 mt-2">
                            Proceed to Paystack
                        </button>
                    </form>
                </div>

            </div>
        </div>
    </div>

</main>



<script>
    const payButton = document.getElementById('payButton');
    const paymentForm = document.getElementById('paymentForm');

    // Show modal
    payButton?.addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
        modal.show();
    });

    // Listen for form submit
    paymentForm?.addEventListener('submit', async (event) => {
        event.preventDefault(); // prevent page reload

        // Build payload using FormData → plain object
        const formData = new FormData(paymentForm);
        const payload = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/order/initiate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.success && data.authorization_url) {
                window.location.href = data.authorization_url;
            } else {
                alert(data.message || 'Failed to initiate payment.');
            }
        } catch (error) {
            console.error(error);
            alert("Error initiating payment.");
        }
    });
</script>