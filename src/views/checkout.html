<main>
    <!-- ========== PAGE HEADER ========== -->
    <section class="page-header-section py-5">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <h1 class="page-title">Checkout</h1>
                    <p class="page-subtitle">Review your items and complete your purchase</p>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb justify-content-center">
                            <li class="breadcrumb-item"><a href="/">Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- ========== CART ITEMS ========== -->
    <section class="checkout-cart-section py-5">
        <div class="container">
            {{#if products.length}}
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each products}}
                                <tr>
                                    <td>
                                        <img src="{{{this.image_url}}}" alt="{{this.name}}" class="img-fluid"
                                            style="width:80px; height:80px; object-fit:cover;">
                                    </td>
                                    <td>{{this.name}}</td>
                                    <td>₦{{this.price}}</td>
                                    <td>
                                        <input type="number" class="form-control quantity-input"
                                            data-product-id="{{this.id}}" value="{{this.quantity}}" min="1">
                                    </td>
                                    <td>₦{{multiply this.price this.quantity}}</td>
                                </tr>
                                {{/each}}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="4" class="text-end">Total:</th>
                                    <th>
                                        ₦{{totalPrice products}}
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Checkout Button -->
            <div class="row mt-4">
                <div class="col-12 text-end">
                    <button id="payButton" class="btn btn-success btn-lg">Proceed to Payment</button>
                </div>
            </div>

            {{else}}
            <div class="row">
                <div class="col-12 text-center py-5">
                    <h4>Your cart is empty!</h4>
                    <a href="/product" class="btn btn-primary mt-3">Shop Products</a>
                </div>
            </div>
            {{/if}}
        </div>
    </section>
</main>



<script>
    document.getElementById('payButton')?.addEventListener('click', async () => {
        try {
            // Call your backend to initialize payment
            const response = await fetch('/order/initiate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: prompt("Please enter your email to continue payment") // get customer email
                })
            });

            const data = await response.json();

            if (data.success && data.authorization_url) {
                // Redirect user to Paystack hosted payment page
                window.location.href = data.authorization_url;
            } else {
                alert(data.message || 'Failed to initiate payment. Please try again.');
            }
        } catch (error) {
            console.error('Payment initiation error:', error);
            alert('An error occurred while initiating payment.');
        }
    });
</script>